@using BZDesktopApp.Services
@using BZDesktopApp.Shared.Dtos
@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject AuthenticationService AuthService

<div class="flex h-screen bg-[#F5F5F5]">
    <div class="w-1/5 bg-white shadow-lg overflow-y-auto">
        <NavMenu />
    </div>

    <main class="overflow-x-hidden rounded-lg">
        <div class="bg-white shadow-sm rounded-lg px-4 py-4 flex items-center m-5">
            <!-- Left group: menu toggle + search -->
            <div class="flex items-center gap-3 flex-1">
                <button data-drawer-target="logo-sidebar" data-drawer-toggle="logo-sidebar" aria-controls="logo-sidebar" type="button" class="inline-flex items-center p-2 text-sm text-primary rounded-lg sm:hidden hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600">
                    <span class="sr-only">Open sidebar</span>
                    <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path clip-rule="evenodd" fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z"></path>
                    </svg>
                </button>
            </div>

            <!-- Right group: profile info + avatar/dropdown -->
            <div class="flex items-center gap-2">
                <div class="font-medium dark:text-white text-right">
                    <div>@(user?.FullName ?? "Guest User")</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Super Admin</div>
                </div>
                <div class="flex items-center">
            <div class="flex items-center ms-3">
                <!-- Avatar Button -->
                <button type="button"
                        data-dropdown-toggle="dropdown-user"
                        class="relative flex text-sm rounded-full focus:ring-4 focus:ring-primary/40 dark:focus:ring-gray-600">
                            <span class="sr-only">@((string.IsNullOrEmpty(user?.Role) ? "Guest" : user!.Role))</span>

                    <!-- Avatar Wrapper -->
                            <div class="w-10 h-10 rounded-full overflow-hidden bg-gradient-to-r from-emerald-600 to-emerald-500 flex items-center justify-center">
                                <img id="userAvatar"
                                     class="w-10 h-10 rounded-full object-cover"
                                     src="@GetAvatar()"

                                     alt="user photo"
                                     onerror="showFallbackAvatar('@user?.FullName')" />

                                <span id="userInitials"
                                      class="hidden font-medium text-white text-sm"></span>
                            </div>
                </button>

                <!-- Dropdown Menu -->
                <div id="dropdown-user"
                     class="z-50 hidden my-4 text-base bg-white divide-y divide-gray-100 rounded-sm shadow-sm dark:bg-gray-700 dark:divide-gray-600">
                    <div class="px-4 py-3" role="none">
                        <p class="text-sm font-medium text-gray-900 truncate dark:text-gray-300" role="none">
                                     @user?.FullName
                        </p>
                        <p class="text-xs text-gray-800 dark:text-white" role="none">
                                    @user?.Email
                        </p>
                    </div>
                    <ul class="py-1" role="none">
                        <li>
                            <a href="#"
                               class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-600 dark:hover:text-white"
                               role="menuitem">
                                Profile
                            </a>
                        </li>
                        <li>
                            <a
                               @onclick="SignOut"
                                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-600 dark:hover:text-white"
                                       role="menuitem">
                                Sign out
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
            </div>
        </div>
        
        <div class="overflow-y-auto">
            <div class="flex-1 mx-5">
                @Body
            </div>
        </div>
    </main>
</div>

<script>
    function showFallbackAvatar(fullName) {
        const avatarImg = document.getElementById('userAvatar');
        const initialsEl = document.getElementById('userInitials');

        if (avatarImg) {
            avatarImg.style.display = "none";
        }

        if (initialsEl) {
            const initials = fullName
                ?.split(' ')
                .filter(n => n.length > 0)
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .slice(0, 2) || "GU"; // Defaults to "GU" = Guest User

            initialsEl.textContent = initials;
            initialsEl.classList.remove("hidden");
        }
    }
</script>


@code {
    private LoginResponse? user;
    private string searchQuery = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();
        user = await AuthService.GetUserAsync();

        // subscribe using a void handler that runs async work via InvokeAsync
        AuthService.OnAuthenticationChanged += HandleAuthChanged;
    }

    // Matches Action signature (void). Use InvokeAsync to run async code on UI thread.
    private void HandleAuthChanged()
    {
        _ = InvokeAsync(async () =>
        {
            user = await AuthService.GetUserAsync();
            StateHasChanged();
        });
    }


    private string GetAvatar()
    {
        if (!string.IsNullOrEmpty(user?.AvatarUrl))
            return user!.AvatarUrl.StartsWith("http") ? user.AvatarUrl : $"{Navigation.BaseUri.TrimEnd('/')}{user.AvatarUrl}";

        return $"https://ui-avatars.com/api/?name={Uri.EscapeDataString(user?.FullName ?? "User")}&background=0D8ABC&color=fff";
    }

    private async Task SignOut()
    {
        await AuthService.LogoutAsync();
        user = null;
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    private Task OnSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery))
            Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(searchQuery)}");
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        // Unsubscribe the same handler so there are no memory leaks
        AuthService.OnAuthenticationChanged -= HandleAuthChanged;
    }
}

