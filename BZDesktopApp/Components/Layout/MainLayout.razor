@using BZDesktopApp.Services
@using BZDesktopApp.Shared.Dtos
@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject AuthenticationService AuthService

<div class="flex h-screen bg-gray-50">
    <div class="w-1/5 bg-white shadow-lg overflow-y-auto">
        <NavMenu />
    </div>

    <main class="flex-1 overflow-hidden flex flex-col rounded-lg">
        <div class="bg-white shadow-sm rounded-lg px-4 py-4 flex items-center m-5">
            <!-- Left group: menu toggle + search -->
            <div class="flex items-center gap-3 flex-1">
                <button class="p-2 text-gray-500 hover:text-gray-700 focus:outline-none">
                    <!-- Add your menu toggle icon here -->
                    <i class="fa-solid fa-bars"></i>
                </button>

                <form class="max-w-md mx-2 w-full" @onsubmit="OnSearch">
                    <div class="relative">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none text-gray-500">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </div>
                        <input @bind="searchQuery"
                               type="search"
                               id="default-search"
                               class="block w-full p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                               placeholder="Search About System ..." />
                        <button type="submit"
                                class="text-white absolute end-2.5 bottom-2.5 bg-emerald-600 hover:bg-emerald-700 focus:ring-4 focus:outline-none focus:ring-emerald-300 font-medium rounded-lg text-sm px-4 py-1">
                            Search
                        </button>
                    </div>
                </form>
            </div>

            <!-- Right group: profile info + avatar/dropdown -->
            <div class="flex items-center gap-2">
                <div class="font-medium dark:text-white text-right">
                    <div>@(user?.FullName ?? "Guest User")</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">@((string.IsNullOrEmpty(user?.Role) ? "Guest" : user!.Role))</div>
                </div>

                <div class="flex items-center ms-3 relative">
                    <button class="flex text-sm bg-gray-800 rounded-full focus:ring-4 focus:ring-primary/40" @onclick="ToggleDropdown" aria-expanded="@isDropdownOpen">
                        <span class="sr-only">Open user menu</span>
                        <img class="w-10 h-10 rounded-full object-cover" src="@GetAvatar()" alt="user photo" />
                    </button>

                    @if (isDropdownOpen)
                    {
                        <div class="absolute right-0 z-50 mt-3 w-48 text-base list-none bg-white divide-y divide-gray-100 rounded-md shadow-lg dark:bg-gray-700 dark:divide-gray-600">
                            <div class="px-4 py-3" role="none">
                                <p class="text-sm text-gray-900 dark:text-white" role="none">@user?.FullName</p>
                                <p class="text-sm font-medium text-gray-900 truncate dark:text-gray-300" role="none">@user?.Email</p>
                            </div>
                            <ul class="py-1" role="none">
                                <li>
                                    <a href="/dashboard" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-600" role="menuitem">Dashboard</a>
                                </li>
                                <li>
                                    <a href="/settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-600" role="menuitem">Settings</a>
                                </li>
                                <li>
                                    <button class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-600" @onclick="SignOut">
                                        Sign out
                                    </button>
                                </li>
                            </ul>
                        </div>
                    }
                </div>
            </div>
        </div>

        <article class="flex-1 overflow-y-auto p-6">
            @Body
        </article>
    </main>
</div>

@code {
    private LoginResponse? user;
    private bool isDropdownOpen = false;
    private string searchQuery = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();
        user = await AuthService.GetUserAsync();

        // subscribe using a void handler that runs async work via InvokeAsync
        AuthService.OnAuthenticationChanged += HandleAuthChanged;
    }

    // Matches Action signature (void). Use InvokeAsync to run async code on UI thread.
    private void HandleAuthChanged()
    {
        _ = InvokeAsync(async () =>
        {
            user = await AuthService.GetUserAsync();
            StateHasChanged();
        });
    }

    private void ToggleDropdown() => isDropdownOpen = !isDropdownOpen;

    private string GetAvatar()
    {
        if (!string.IsNullOrEmpty(user?.AvatarUrl))
            return user!.AvatarUrl.StartsWith("http") ? user.AvatarUrl : $"{Navigation.BaseUri.TrimEnd('/')}{user.AvatarUrl}";

        return $"https://ui-avatars.com/api/?name={Uri.EscapeDataString(user?.FullName ?? "User")}&background=0D8ABC&color=fff";
    }

    private async Task SignOut()
    {
        await AuthService.LogoutAsync();
        user = null;
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    private Task OnSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery))
            Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(searchQuery)}");
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        // Unsubscribe the same handler so there are no memory leaks
        AuthService.OnAuthenticationChanged -= HandleAuthChanged;
    }
}

