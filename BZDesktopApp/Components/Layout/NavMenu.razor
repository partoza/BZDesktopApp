@using System.Text.Json
@using Microsoft.JSInterop
@inject IJSRuntime JS

@using BZDesktopApp.Shared
@using BZDesktopApp.Services
@using BZDesktopApp.Shared.Dtos
@inject AuthenticationService AuthService
@inject NavigationManager NavManager

<aside id="logo-sidebar" class="fixed top-0 left-0 z-40 w-1/5 h-screen pt-20 bg-white dark:bg-gray-800">
    <div class="h-full px-3 pb-4 overflow-y-auto">
        <ul class="space-y-2 font-medium">
            @if (UserRole != null)
            {
                foreach (var item in MenuConfig.GetMenu().Where(m => m.Roles == null || m.Roles.Contains(UserRole)))
                {
                    <li>
                        @if (item.Children != null && item.Children.Any(c => c.Roles == null || c.Roles.Contains(UserRole)))
                        {
                            <button @onclick="() => ToggleDropdown(item.Title)"
                                    class="flex items-center w-full p-2 text-base text-gray-900 rounded-lg hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700 transition duration-75">
                                @((MarkupString)(item.IconSvg ?? string.Empty))
                                <span class="flex-1 ms-3 text-left">@item.Title</span>
                                <svg class="w-3 h-3" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-width="2" d="m1 1 4 4 4-4" /></svg>
                            </button>
                            <ul class="@GetDropdownClass(item.Title) py-2 space-y-2">
                                @foreach (var child in item.Children.Where(c => c.Roles == null || c.Roles.Contains(UserRole)))
                                {
                                    <li>
                                        <NavLink href="@child.Uri" class="flex items-center w-full p-2 pl-11 rounded-lg hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700">
                                            @((MarkupString)(child.IconSvg ?? string.Empty))
                                            <span class="ms-3">@child.Title</span>
                                        </NavLink>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <NavLink href="@item.Uri" class="flex items-center w-full p-2 rounded-lg hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700">
                                @((MarkupString)(item.IconSvg ?? string.Empty))
                                <span class="ms-3">@item.Title</span>
                            </NavLink>
                        }
                    </li>
                }
            }
        </ul>   
    </div>
</aside>

@code {
    private string? UserRole;
    private HashSet<string> openDropdowns = new();

    protected override async Task OnInitializedAsync()
    {
        var userJson = await JS.InvokeAsync<string>("localStorage.getItem", "bz_user");
        if (!string.IsNullOrEmpty(userJson))
        {
            var userObj = JsonSerializer.Deserialize<LoginResponse>(userJson, new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            });
            UserRole = userObj?.Role;
        }
    }

    private void ToggleDropdown(string title)
    {
        if (openDropdowns.Contains(title))
            openDropdowns.Remove(title);
        else
            openDropdowns.Add(title);
    }

    private string GetDropdownClass(string title) => openDropdowns.Contains(title) ? "block" : "hidden";
}
