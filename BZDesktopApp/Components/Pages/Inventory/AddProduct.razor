@page "/addProduct"
@using System.Collections.Generic
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<div class="overflow-hidden">
    <!-- Header -->
    <div class="flex items-center justify-between bg-white rounded-xl shadow-sm px-6 py-3">
        <div>
            <h2 class="text-xl font-bold text-primary whitespace-nowrap">Add New Product</h2>
            <p class="text-sm text-gray-600 mt-1">Please fill up all the required fields to add new product.</p>
        </div>
        <div class="flex items-center gap-3">
            <button type="button" @onclick="GoBack"
                class="inline-flex items-center gap-2 px-4 py-2 border-2 border-secondary text-secondary rounded-lg text-gray-700 hover:bg-gray-300 hover:text-black transition-colors duration-200 font-medium">
                Back
            </button>

            <button type="button" @onclick="Discard"
                class="inline-flex items-center gap-2 px-4 py-2 border-2 border-secondary text-secondary rounded-lg font-medium hover:bg-red-500 hover:text-white transition-colors duration-200">
                Discard
            </button>
        </div>
    </div>

    <!-- Form -->
    <EditForm Model="productModel" OnValidSubmit="SubmitProduct">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
            <!-- Left Panel: Product Info -->
            <div class="lg:col-span-2 bg-white py-4 px-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Product Information</h3>

                <!-- Product Name -->
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                    <InputText @bind-Value="productModel.ProductName"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg placeholder:font-normal placeholder:text-gray-400"
                        placeholder="Intel Core i9 12th" />
                    <ValidationMessage For="@(() => productModel.ProductName)" class="text-sm text-red-600 mt-1" />
                </div>

                <!-- Description -->
                <div class="mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <InputTextArea @bind-Value="productModel.Description"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder:font-normal placeholder:text-gray-400"
                        rows="4" placeholder="Enter product description..." />
                    <ValidationMessage For="@(() => productModel.Description)" class="text-sm text-red-600 mt-1" />
                </div>

                <!-- Product Image -->
                <div class="mb-5">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Product Image</h3>
                    <InputFile OnChange="OnInputFileChange" accept="image/*" />
                    @if (!string.IsNullOrEmpty(productImagePreview))
                    {
                        <img src="@productImagePreview" class="mt-2 max-h-64 rounded-lg object-contain" />
                    }
                </div>

                <!-- Pricing -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Base Price</label>
                        <InputNumber @bind-Value="productModel.BasePrice"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder:font-normal placeholder:text-gray-400" />
                        <ValidationMessage For="@(() => productModel.BasePrice)" class="text-sm text-red-600 mt-1" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Discounted Price</label>
                        <InputNumber @bind-Value="productModel.DiscountedPrice"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder:font-normal placeholder:text-gray-400"
                            disabled />
                    </div>
                </div>
            </div>

            <!-- Right Panel: Classification + Additions -->
            <div class="flex flex-col space-y-3">
                <!-- Classification -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Classification</h3>
                    <div class="space-y-3">
                        <!-- Brand -->
                        <div>
                            <label class="block text-sm text-gray-600 mb-1 mt-2">Brand</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white" @bind="productModel.BrandId">
                                <option value="">Select Brand</option>
                                @foreach (var brand in brands)
                                {
                                    <option value="@brand.Id">@brand.Name</option>
                                }
                            </select>
                        </div>

                        <!-- Main Category -->
                        <div>
                            <label class="block text-sm text-gray-600 mb-1 mt-2">Main Category</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white" @bind="productModel.MainCategoryId">
                                <option value="">Select Main Category</option>
                                @foreach (var category in mainCategories)
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            </select>
                        </div>

                        <!-- Subcategory -->
                        <div>
                            <label class="block text-sm text-gray-600 mb-1 mt-2">Subcategory</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white" @bind="productModel.SubCategoryId" disabled="@(subCategories.Count == 0)">
                                <option value="">Select Subcategory</option>
                                @foreach (var sub in subCategories)
                                {
                                    <option value="@sub.Id">@sub.Name</option>
                                }
                            </select>
                        </div>

                        <!-- Status -->
                        <div>
                            <label class="block text-sm text-gray-600 mb-1 mt-2">Status</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white" @bind="productModel.Status">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Additions -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Additions</h3>
                    <!-- Promo Code -->
                    <div class="mb-3">
                        <label class="block text-sm text-gray-600 mb-1">Promo Code</label>
                        <InputText @bind-Value="productModel.PromoCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter promo code"/>
                    </div>

                    <!-- Track Serials -->
                    <div class="flex items-center gap-2 mb-3">
                        <InputCheckbox @bind-Value="productModel.TrackSerials" class="accent-primary" />
                        <label class="text-gray-700">Track serials for this product</label>
                    </div>

                    <!-- Warranty -->
                    @if (productModel.TrackSerials)
                    {
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Warranty</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white" @bind="productModel.WarrantyPeriod">
                                <option value="0">No Warranty</option>
                                <option value="3">3 Months</option>
                                <option value="6">6 Months</option>
                                <option value="12">12 Months</option>
                            </select>
                        </div>
                    }
                </div>

                <!-- Submit -->
                <button type="submit" class="w-full px-4 py-3 bg-primary font-medium hover:bg-emerald-700 text-white rounded-lg mt-4">Publish Product</button>
            </div>
        </div>
    </EditForm>
</div>

@code {
    private ProductModel productModel = new ProductModel();
    private string? productImagePreview;

    private List<Brand> brands = new() {
        new Brand { Id = 1, Name = "Intel" },
        new Brand { Id = 2, Name = "AMD" }
    };

    private List<Category> mainCategories = new() {
        new Category { Id = 1, Name = "CPU" },
        new Category { Id = 2, Name = "GPU" }
    };

    private List<Category> subCategories = new();

    private void GoBack() => NavigationManager.NavigateTo("/products");
    private void Discard() => NavigationManager.NavigateTo("/products");

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var buffer = new byte[file.Size];
        await file.OpenReadStream().ReadAsync(buffer);
        productImagePreview = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
    }

    private void LoadSubcategories(ChangeEventArgs e)
    {
        int selectedMainId = int.TryParse(e.Value?.ToString(), out var id) ? id : 0;
        // Example logic: replace with actual DB call
        if (selectedMainId == 1)
            subCategories = new List<Category> { new Category { Id = 101, Name = "Desktop CPU" }, new Category { Id = 102, Name = "Laptop CPU" } };
        else if (selectedMainId == 2)
            subCategories = new List<Category> { new Category { Id = 201, Name = "Gaming GPU" }, new Category { Id = 202, Name = "Workstation GPU" } };
        else
            subCategories = new();
    }

    private void SubmitProduct()
    {
        // TODO: Save productModel to your database
    }

    public class ProductModel
    {
        public string ProductName { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public decimal BasePrice { get; set; }
        public decimal? DiscountedPrice { get; set; }
        public int? BrandId { get; set; }
        public int? MainCategoryId { get; set; }
        public int? SubCategoryId { get; set; }
        public string Status { get; set; } = "Active";
        public string? PromoCode { get; set; }
        public bool TrackSerials { get; set; }
        public int WarrantyPeriod { get; set; } = 0;
    }

    public class Brand { public int Id { get; set; } public string Name { get; set; } = string.Empty; }
    public class Category { public int Id { get; set; } public string Name { get; set; } = string.Empty; }
}
