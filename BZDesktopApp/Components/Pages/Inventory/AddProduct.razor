@page "/addProduct"
@page "/addProduct/{ProductId:long?}"
@using System.Globalization
@using BZDesktopApp.Shared.Dtos
@using System.Net.Http.Json
@inject IJSRuntime JS
@inject NavigationManager Nav
@using Facades;

<AuthGuard>
    <div class="overflow-hidden">
        <!-- Header -->
        <div class="flex items-center justify-between bg-white rounded-xl shadow-sm px-6 py-3">
            <div>
                <h2 class="text-xl font-bold text-primary whitespace-nowrap">
                    @(ProductId == null ? "Add New Product" : "Edit Product")
                </h2>
                <p class="text-sm text-gray-600 mt-1">
                    @(ProductId == null ? "Please fill up all required fields to add a new product." : "Modify the fields below to update this product.")
                </p>
            </div>
            <div class="flex items-center gap-3">
                <button type="button"
                        class="inline-flex items-center gap-2 px-4 py-2 border-2 border-secondary text-secondary rounded-lg text-gray-700 hover:bg-gray-300 hover:text-black transition-colors duration-200 font-medium"
                        @onclick="GoBack">
                    Back
                </button>

                <button type="button"
                        class="inline-flex items-center gap-2 px-4 py-2 border-2 border-secondary text-secondary rounded-lg font-medium hover:bg-red-500 hover:text-white transition-colors duration-200"
                        @onclick="ResetForm">
                    Discard
                </button>
            </div>
        </div>

        <!-- Product Form -->
        <EditForm Model="@productForm" OnValidSubmit="@HandleSubmit">
            <DataAnnotationsValidator />

            <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
                <!-- Left Panel -->
                <div class="lg:col-span-2 bg-white py-4 px-6 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Product Information</h3>

                    <!-- ProductName -->
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                        <InputText @bind-Value="productForm.ProductName" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Intel Core i9 12th" />
                        <ValidationMessage For="@(() => productForm.ProductName)" class="text-red-500 text-sm" />
                    </div>

                    <!-- Description -->
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <InputTextArea @bind-Value="productForm.Description" class="w-full px-4 py-3 border border-gray-300 rounded-lg" rows="4" placeholder="Enter product description..." />
                    </div>

                    <!-- Image Upload -->
                    <div class="mb-5">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Product Image</h3>

                        <!-- File input -->
                        <InputFile OnChange="HandleFileSelected" accept="image/*" class="mb-2" />

                        <!-- Preview container -->
                        <div class="mt-2 w-full h-40 border border-gray-300 rounded-md flex items-center justify-center bg-gray-50 overflow-hidden relative">
                            @if (!string.IsNullOrEmpty(productForm.ImageUrl))
                            {
                                <img src="@productForm.ImageUrl" class="object-contain w-full h-full" />
                                <button type="button" class="absolute top-1 right-1 text-white bg-red-500 rounded-full p-1 hover:bg-red-600"
                                        @onclick="ClearImage">
                                    ✕
                                </button>
                            }
                            else
                            {
                                <span class="text-gray-400 text-sm">No image selected</span>
                            }
                        </div>
                    </div>

                </div>

                <!-- Right Panel -->
                <div class="flex flex-col space-y-3">
                    <!-- Classification -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Classification</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 mt-2">Brand</label>
                                <select @bind="productForm.BrandId" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="@((long?)null)">Select Brand</option>
                                    @foreach (var b in brands)
                                    {
                                        <option value="@b.Id">@b.Name</option>
                                    }
                                </select>
                                <button type="button" class="btn btn-primary mt-2" @onclick="OpenBrandModal">Add Brand</button>
                            </div>



                            <div>
                                <label class="block text-sm text-gray-600 mb-1 mt-2">Main Category</label>
                                <select @bind="productForm.CategoryId" @bind:after="OnMainCategoryChanged"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">Select Main Category</option>
                                    @foreach (var cat in ParentCategories)
                                    {
                                        <option value="@cat.Id">@cat.Name</option>
                                    }
                                </select>
                                <ValidationMessage For="@(() => productForm.CategoryId)" class="text-red-500 text-sm" />

                            </div>

                            <div>
                                <label class="block text-sm text-gray-600 mb-1 mt-2">Subcategory</label>
                                <select @bind="productForm.SubCategoryId"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white"
                                        disabled="@(!SubCategories.Any())">
                                    <option value="">Select Subcategory</option>
                                    @foreach (var sub in SubCategories)
                                    {
                                        <option value="@sub.Id">@sub.Name</option>
                                    }
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm text-gray-600 mb-1 mt-2">Status</label>
                                <InputSelect @bind-Value="productForm.ActiveStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </InputSelect>
                            </div>
                        </div>
                    </div>

                    <!-- Additions -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Additions</h3>
                        <div class="mb-3">
                            <label class="block text-sm text-gray-600 mb-1">Promo Code</label>
                            <InputText @bind-Value="productForm.PromoCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter promo code" />
                        </div>
                    </div>

                    <!-- Submit -->
                    <button type="submit" class="w-full px-4 py-3 bg-primary font-medium hover:bg-emerald-700 text-white rounded-lg mt-4" disabled="@isSubmitting">
                        @(isSubmitting ? (ProductId == null ? "Publishing..." : "Saving...") : (ProductId == null ? "Publish Product" : "Save Changes"))
                    </button>
                </div>
            </div>
        </EditForm>
    </div>
    <!-- Flowbite Add Brand Modal -->
    <div id="addBrandModal" data-modal-backdrop="static" tabindex="-1" aria-hidden="true"
         class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full bg-gray-700/70 backdrop-blur-sm">
        <div class="relative p-4 max-w-md w-full">
            <div class="relative bg-white rounded-lg shadow border border-gray-200">
                <!-- Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 rounded-t">
                    <h3 class="text-xl font-semibold text-gray-800">Add Brand</h3>
                    <button type="button"
                            class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 flex justify-center items-center"
                            @onclick="() => CloseBrandModal()">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                             viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                        </svg>
                        <span class="sr-only">Close modal</span>
                    </button>
                </div>

                <!-- Body -->
                <div class="p-4 space-y-4">
                    <label class="block text-sm font-medium text-gray-700">Brand Name</label>
                    <InputText @bind-Value="newBrandName"
                               class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500" />
                </div>

                <!-- Footer -->
                <div class="flex justify-end gap-3 p-4 border-t border-gray-200">
                    <button type="button"
                            class="px-4 py-2 border rounded-xl text-gray-700 hover:bg-gray-100"
                            @onclick="() => CloseBrandModal()">
                        Cancel
                    </button>
                    <button type="button"
                            class="px-4 py-2 bg-primary hover:bg-emerald-700 text-white rounded-xl font-medium shadow-sm"
                            @onclick="AddBrand"
                            disabled="@string.IsNullOrWhiteSpace(newBrandName)">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>


</AuthGuard>

@code {
    [Inject] private ProductsFacade ProductsFacade { get; set; } = default!;
    [Inject] private CategoriesFacade CategoriesFacade { get; set; } = default!;
    [Parameter] public long? ProductId { get; set; }

    private ProductForm productForm = new();
    private List<CategoryDto> categories = new();
    private List<BrandDto> brands = new();
    private bool isSubmitting = false;
    private string? uploadedImageBase64;

    private List<CategoryDto> ParentCategories = new();
    private List<CategoryDto> SubCategories = new();
        
    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        await LoadBrands();

        // if (ProductId != null)
        //     await LoadProduct(ProductId.Value);
    }

    private async Task LoadCategories()
    {
        try
        {
            var summary = await CategoriesFacade.GetCategoriesAsync();
            categories = summary?.Categories ?? new List<CategoryDto>();

            // Populate main (parent) categories
            ParentCategories = categories.Where(c => c.ParentId == null).ToList();
        }
        catch
        {
            categories = new List<CategoryDto>();
            ParentCategories = new List<CategoryDto>();
        }
    }

    private async Task LoadBrands()
    {
        try
        {
            brands = await ProductsFacade.GetBrandsAsync();
        }
        catch
        {
            brands = new List<BrandDto>();
        }
    }

    // private async Task LoadProduct(long id)
    // {
    //     try
    //     {
    //         var product = await Http.GetFromJsonAsync<ProductDto>($"api/products/{id}");
    //         if (product != null)
    //         {
    //             productForm = new ProductForm
    //             {
    //                 ProductName = product.ProductName,
    //                 Description = product.Description,
    //                 PromoCode = product.PromoCode,
    //                 CategoryId = product.CategoryId,
    //                 SubCategoryId = product.SubCategoryId,
    //                 BrandId = product.BrandId,
    //                 ActiveStatus = product.ActiveStatus,
    //                 ImageUrl = product.ImageUrl 
    //             };
    //         }
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine($"Error loading product: {ex.Message}");
    //     }
    // }

    // private async Task LoadProduct(long id)
    // {
    //     try
    //     {
    //         var product = await ProductsFacade.GetProductByIdAsync(id);
    //         if (product != null)
    //         {
    //             productForm = new ProductForm
    //             {
    //                 ProductName = product.ProductName,
    //                 Description = product.Description,
    //                 PromoCode = product.PromoCode,
    //                 CategoryId = product.CategoryId,
    //                 SubCategoryId = product.SubCategoryId,
    //                 BrandId = product.BrandId,
    //                 ActiveStatus = product.ActiveStatus,
    //                 ImageUrl = product.ImageUrl
    //             };
    //         }
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine($"Error loading product: {ex.Message}");
    //     }
    // }


    private async Task HandleSubmit()
    {
        isSubmitting = true;
        try
        {
            ProductDto result;

            if (ProductId == null)
            {
                // Create new product
                result = await ProductsFacade.CreateProductAsync(productForm, userId: 1); // provide the user id
                await JS.InvokeVoidAsync("alert", "Product added successfully!");
            }
            else
            {
                // Update product (if you implement UpdateProductAsync in your facade)
                // result = await ProductsFacade.UpdateProductAsync(ProductId.Value, productForm, userId: 1);
                // await JS.InvokeVoidAsync("alert", "Product updated successfully!");
            }

            Nav.NavigateTo("/products");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void ResetForm() => productForm = new ProductForm();

    private void GoBack() => Nav.NavigateTo("/products");

    private IBrowserFile? selectedFile;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            selectedFile = file; // store locally for upload

            using var stream = new MemoryStream();
            await file.OpenReadStream(10_000_000).CopyToAsync(stream);
            var bytes = stream.ToArray();
            var base64 = Convert.ToBase64String(bytes);
            productForm.ImageUrl = $"data:{file.ContentType};base64,{base64}";
        }
    }

    private void ClearImage()
    {
        productForm.ImageUrl = null;
    }

    private void OnMainCategoryChanged()
    {
        if (productForm.CategoryId != null)
        {
            SubCategories = categories
                .Where(c => c.ParentId == productForm.CategoryId)
                .ToList();
        }
        else
        {
            SubCategories = new List<CategoryDto>();
        }

        // Reset subcategory selection
        productForm.SubCategoryId = null;
    }

    private string? newBrandName;

    // Open modal
    private void OpenBrandModal()
    {
        newBrandName = null;
        JS.InvokeVoidAsync("initBrandModal", "addBrandModal");
        JS.InvokeVoidAsync("showBrandModal", "addBrandModal");
    }

    // Close modal
    private void CloseBrandModal()
    {
        JS.InvokeVoidAsync("closeBrandModal", "addBrandModal");
    }

    // Add brand
    private async Task AddBrand()
    {
        if (string.IsNullOrWhiteSpace(newBrandName))
            return;

        try
        {
            var createdBrand = await ProductsFacade.CreateBrandAsync(newBrandName);
            if (createdBrand != null)
            {
                await LoadBrands(); // reload brand list
                productForm.BrandId = createdBrand.Id; // auto-select
            }
            CloseBrandModal();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    
}
