@page "/login"
@using Microsoft.AspNetCore.Components.Forms
@using BZDesktopApp.Services;
@layout Components.Layout.AuthLayout
@inject AuthenticationService AuthService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Login - BZ IT Solutions</PageTitle>

<GuestGuard>
    <div class="relative flex min-h-screen flex-col bg-white"
     style="background: url('/images/background/login-bg.jpg') no-repeat center/cover; background-attachment: scroll;">

    <!-- Overlay Gradient -->
    <div class="pointer-events-none absolute inset-0"
         style="background: linear-gradient(to right, rgba(239,238,238,1), rgba(255,255,255,0.8), rgba(255,255,255,0));">
    </div>

    <!-- Main Content -->
    <div class="relative z-10 flex-grow">
        <div class="grid min-h-screen grid-cols-1 gap-0 md:grid-cols-12 md:px-24">
            <!-- Empty left space (col-1) - hidden on mobile -->
            <div class="hidden md:col-span-1 md:block"></div>

            <!-- Welcome Section -->
            <div class="col-span-1 flex items-center justify-center p-8 md:col-span-6 md:p-0">
                <div class="w-full space-y-6">
                    <div class="space-y-3">
                        <div class="inline-block">
                            <span class="rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold text-primary">Welcome Back👋</span>
                        </div>
                        <h3 class="text-4xl font-light text-gray-900 md:text-5xl">Welcome to</h3>
                        <h2 class="text-5xl leading-tight font-bold tracking-tight text-primary md:text-7xl">
                            BZ IT<br />Solutions
                        </h2>
                    </div>
                    <p class="max-w-lg text-base leading-relaxed font-light text-gray-600 md:text-lg">
                        Access your secure portal to manage inventory, track sales,
                        and streamline your business operations efficiently.
                    </p>

                    <!-- Feature List -->
                    <div class="grid grid-cols-1 gap-4 pt-4 md:grid-cols-2">
                        <div class="flex items-center gap-3">
                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-primary/10">
                                <span class="text-sm text-primary">✓</span>
                            </div>
                            <span class="text-sm text-gray-900">Real-Time Inventory Management</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-primary/10">
                                <span class="text-sm text-primary">✓</span>
                            </div>
                            <span class="text-sm text-gray-900">Point of Sales System</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-primary/10">
                                <span class="text-sm text-primary">✓</span>
                            </div>
                            <span class="text-sm text-gray-900">Service Automation Process</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Login Form Section -->
            <div class="col-span-1 flex items-center justify-center p-8 md:col-span-4 md:p-0">
                <div class="w-full max-w-md">
                    <div class="rounded-lg bg-white p-8 shadow-2xl backdrop-blur-sm">

                        <!-- Title -->
                        <div class="mb-6">
                            <h3 class="mb-2 text-2xl font-semibold text-primary md:text-3xl">Sign In</h3>
                            <p class="text-sm text-gray-600">Access your dashboard securely</p>
                        </div>

                        <div class="space-y-5">
                            <!-- Username Input -->
                            <div class="space-y-2">
                                <label for="username" class="block text-xs font-semibold text-gray-800 md:text-sm">
                                    Username
                                </label>
                                <input type="text"
                                       id="username"
                                       @bind="username"
                                       @bind:event="oninput"
                                       class="w-full rounded-lg border-2 @(validationErrors.ContainsKey("username") ? "border-red-600" : "border-gray-300") px-4 py-3 text-xs transition-all duration-200 focus:ring-opacity-30 focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none md:text-sm"
                                       placeholder="Enter your username">
                                @if (validationErrors.ContainsKey("username"))
                                {
                                    <span class="text-xs text-red-600">@validationErrors["username"]</span>
                                }
                            </div>

                            <!-- Password Input with Toggle -->
                            <div class="space-y-2">
                                <label for="password" class="block text-xs font-semibold text-gray-800 md:text-sm">
                                    Password
                                </label>
                                <div class="relative">
                                    <input type="@(showPassword ? "text" : "password")"
                                           id="password"
                                           @bind="password"
                                           @bind:event="oninput"
                                           class="w-full rounded-lg border-2 @(validationErrors.ContainsKey("password") ? "border-red-600" : "border-gray-300") px-4 py-3 pr-10 text-xs transition-all duration-200 focus:ring-opacity-30 focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none md:text-sm"
                                           placeholder="Enter your password">

                                    <!-- Eye Icon -->
                                    <button type="button"
                                            class="absolute top-1/2 right-3 -translate-y-1/2 transform cursor-pointer text-gray-500 transition-colors hover:text-primary focus:outline-none"
                                            @onclick="TogglePasswordVisibility">
                                        @if (showPassword)
                                        {
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                            </svg>
                                        }
                                        else
                                        {
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        }
                                    </button>
                                </div>
                                @if (validationErrors.ContainsKey("password"))
                                {
                                    <span class="text-xs text-red-600">@validationErrors["password"]</span>
                                }
                            </div>

                            <!-- Error Message -->
                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="rounded-lg border border-red-400 p-3 text-sm text-red-700">
                                    @errorMessage
                                    @if (lockoutSeconds > 0)
                                    {
                                        <span>Please try again in <span id="countdown">@lockoutSeconds</span> seconds.</span>
                                    }
                                </div>
                            }

                            <!-- Sign In Button -->
                            <button type="button"
                                    @onclick="HandleLogin"
                                    disabled="@(isLoading || lockoutSeconds > 0)"
                                    class="w-full transform rounded-lg bg-primary px-6 py-3 font-medium text-white shadow-lg transition-all duration-300 hover:bg-primary-hover hover:scale-105 hover:shadow-xl active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer">
                                @if (isLoading)
                                {
                                    <span>Signing in...</span>
                                }
                                else
                                {
                                    <span>Sign In</span>
                                }
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer (simplified) -->
    <footer class="relative z-10 mx-0 mt-auto border-t border-gray-200 bg-white backdrop-blur-lg">
        <!-- Wavy Divider -->
        <svg class="h-auto w-full" viewBox="0 0 1200 100" preserveAspectRatio="none" style="display: block; margin: 0; padding: 0;">
            <defs>
                <linearGradient id="waveGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color: #2F7D6D; stop-opacity: 1" />
                    <stop offset="100%" style="stop-color: #2F7D6D; stop-opacity: 0.8" />
                </linearGradient>
            </defs>
            <path d="M0,30 Q300,10 600,30 T1200,30 L1200,0 L0,0 Z" fill="url(#waveGradient)" />
            <path d="M0,40 Q300,20 600,40 T1200,40 L1200,30 Q600,50 0,30 Z" fill="#2F7D6D" opacity="0.5" />
        </svg>

        <!-- Main Content Section -->
        <div class="mx-auto max-w-7xl px-4 py-10 md:px-8 md:py-5 lg:px-12">
            <div class="grid grid-cols-1 justify-center gap-12 md:grid-cols-2 lg:grid-cols-3 lg:gap-16">
                <!-- Company Info -->
                <div class="col-span-1 text-center md:text-left">
                    <div class="mb-8 flex flex-col items-center gap-4 md:flex-row md:items-start">
                        <img src="images/logo/bz-logo-green.png"
                             alt="BZ IT Solutions"
                             class="h-auto w-auto object-contain flex-shrink-0 ani-fade"
                             style="--ani-delay:760ms"/>
                        <div>
                            <h5 class="mb-2 text-lg font-semibold text-primary">BZ IT Solutions</h5>
                            <p class="text-sm leading-relaxed text-gray-600">Affordable Computer and CCTV store that caters Mindanao.</p>
                        </div>
                    </div>

                    <!-- Badges -->
                    <div class="flex flex-wrap justify-center gap-2.5 md:justify-start">
                        <span class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-primary/20 px-3 py-1.5 text-xs font-semibold text-primary transition-colors duration-200 hover:bg-opacity-30">
                            <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            Secure & Trusted
                        </span>
                        <span class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-primary/20 px-3 py-1.5 text-xs font-semibold text-primary transition-colors duration-200 hover:bg-opacity-30">
                            <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            Premium Services
                        </span>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="col-span-1 text-center md:col-span-1 md:text-left lg:col-span-1">
                    <h6 class="mb-6 text-sm font-semibold tracking-wide text-gray-800 uppercase">Contact Us</h6>
                    <div class="space-y-5">
                        <div>
                            <p class="mb-1.5 text-xs font-medium tracking-wider text-gray-600 uppercase">Email</p>
                            <a href="mailto:bzitsolutionsdvo@gmail.com" class="text-sm font-medium break-all text-primary transition-colors hover:text-primary-hover">bzitsolutionsdvo@gmail.com</a>
                        </div>
                        <div>
                            <p class="mb-2 text-xs font-medium tracking-wider text-gray-600 uppercase">Locations</p>
                            <p class="text-xs leading-relaxed text-gray-600">Davao • Gensan • Koronadal</p>
                        </div>
                    </div>
                </div>

                <!-- Social Media -->
                <div class="col-span-1 text-center md:col-span-1 md:text-left lg:col-span-1">
                    <h6 class="mb-6 text-sm font-semibold tracking-wide text-gray-800 uppercase">Follow Us</h6>
                    <div class="flex flex-wrap justify-center gap-3 md:justify-start">
                        <!-- Facebook -->
                        <a href="#" title="Facebook" class="flex h-12 w-12 items-center justify-center rounded-full border-2 border-primary/30 bg-primary/20 text-primary transition-all duration-300 hover:border-opacity-100 hover:scale-110 hover:bg-primary-hover hover:text-white hover:shadow-lg">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M240 363.3L240 576L356 576L356 363.3L442.5 363.3L460.5 265.5L356 265.5L356 230.9C356 179.2 376.3 159.4 428.7 159.4C445 159.4 458.1 159.8 465.7 160.6L465.7 71.9C451.4 68 416.4 64 396.2 64C289.3 64 240 114.5 240 223.4L240 265.5L174 265.5L174 363.3L240 363.3z" /></svg>
                        </a>
                        <!-- Instagram -->
                        <a href="#" title="Instagram" class="flex h-12 w-12 items-center justify-center rounded-full border-2 border-primary/30 bg-primary/20 text-primary transition-all duration-300 hover:border-opacity-100 hover:scale-110 hover:bg-primary-hover hover:text-white hover:shadow-lg">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M320.3 205C256.8 204.8 205.2 256.2 205 319.7C204.8 383.2 256.2 434.8 319.7 435C383.2 435.2 434.8 383.8 435 320.3C435.2 256.8 383.8 205.2 320.3 205zM319.7 245.4C360.9 245.2 394.4 278.5 394.6 319.7C394.8 360.9 361.5 394.4 320.3 394.6C279.1 394.8 245.6 361.5 245.4 320.3C245.2 279.1 278.5 245.6 319.7 245.4zM413.1 200.3C413.1 185.5 425.1 173.5 439.9 173.5C454.7 173.5 466.7 185.5 466.7 200.3C466.7 215.1 454.7 227.1 439.9 227.1C425.1 227.1 413.1 215.1 413.1 200.3zM542.8 227.5C541.1 191.6 532.9 159.8 506.6 133.6C480.4 107.4 448.6 99.2 412.7 97.4C375.7 95.3 264.8 95.3 227.8 97.4C192 99.1 160.2 107.3 133.9 133.5C107.6 159.7 99.5 191.5 97.7 227.4C95.6 264.4 95.6 375.3 97.7 412.3C99.4 448.2 107.6 480 133.9 506.2C160.2 532.4 191.9 540.6 227.8 542.4C264.8 544.5 375.7 544.5 412.7 542.4C448.6 540.7 480.4 532.5 506.6 506.2C532.8 480 541 448.2 542.8 412.3C544.9 375.3 544.9 264.5 542.8 227.5zM495 452C487.2 471.6 472.1 486.7 452.4 494.6C422.9 506.3 352.9 503.6 320.3 503.6C287.7 503.6 217.6 506.2 188.2 494.6C168.6 486.8 153.5 471.7 145.6 452C133.9 422.5 136.6 352.5 136.6 319.9C136.6 287.3 134 217.2 145.6 187.8C153.4 168.2 168.5 153.1 188.2 145.2C217.7 133.5 287.7 136.2 320.3 136.2C352.9 136.2 423 133.6 452.4 145.2C472 153 487.1 168.1 495 187.8C506.7 217.3 504 287.3 504 319.9C504 352.5 506.7 422.6 495 452z" /></svg>
                        </a>
                        <!-- Tiktok -->
                        <a href="#" title="Tiktok" class="bg-opaci20 flex h-12 w-12 items-center justify-center rounded-full border-2 border-primary/30 bg-primary/20 text-primary transition-all duration-300 hover:border-opacity-100 hover:scale-110 hover:bg-primary-hover hover:text-white hover:shadow-lg">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M544.5 273.9C500.5 274 457.5 260.3 421.7 234.7L421.7 413.4C421.7 446.5 411.6 478.8 392.7 506C373.8 533.2 347.1 554 316.1 565.6C285.1 577.2 251.3 579.1 219.2 570.9C187.1 562.7 158.3 545 136.5 520.1C114.7 495.2 101.2 464.1 97.5 431.2C93.8 398.3 100.4 365.1 116.1 336C131.8 306.9 156.1 283.3 185.7 268.3C215.3 253.3 248.6 247.8 281.4 252.3L281.4 342.2C266.4 337.5 250.3 337.6 235.4 342.6C220.5 347.6 207.5 357.2 198.4 369.9C189.3 382.6 184.4 398 184.5 413.8C184.6 429.6 189.7 444.8 199 457.5C208.3 470.2 221.4 479.6 236.4 484.4C251.4 489.2 267.5 489.2 282.4 484.3C297.3 479.4 310.4 469.9 319.6 457.2C328.8 444.5 333.8 429.1 333.8 413.4L333.8 64L421.8 64C421.7 71.4 422.4 78.9 423.7 86.2C426.8 102.5 433.1 118.1 442.4 131.9C451.7 145.7 463.7 157.5 477.6 166.5C497.5 179.6 520.8 186.6 544.6 186.6L544.6 274z" /></svg>
                        </a>
                    </div>
                    <p class="mt-4 text-xs text-gray-600">Follow us for more updates</p>
                </div>
            </div>
        </div>

        <!-- Divider Line -->
        <div class="border-t border-gray-200"></div>

        <!-- Bottom Section -->
        <div class="mx-auto max-w-7xl px-4 py-8 md:px-8 lg:px-12">
            <div class="flex flex-col items-center justify-between gap-6 md:flex-row">
                <p class="text-center text-xs text-gray-600 md:text-left">
                    &copy; 2025 BZ IT Solutions. All rights reserved.
                </p>
                <div class="flex gap-6 text-xs">
                    <a href="#" class="text-primary transition-colors hover:text-primary-hover">Privacy Policy</a>
                    <span class="text-gray-300">•</span>
                    <a href="#" class="text-primary transition-colors hover:text-primary-hover">Terms of Service</a>
                    <span class="text-gray-300">•</span>
                    <span class="text-gray-500">v1.0.0</span>
                </div>
            </div>
        </div>
    </footer>
</div>
</GuestGuard>
@code {
    private string username = string.Empty;
    private string password = string.Empty;
    private bool showPassword = false;
    private bool rememberMe = false;
    private string errorMessage = string.Empty;
    private bool isLoading = false;
    private int lockoutSeconds = 0;
    private Dictionary<string, string> validationErrors = new();
    private System.Timers.Timer? lockoutTimer;

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private bool ValidateInputs()
    {
        validationErrors.Clear();

        if (string.IsNullOrWhiteSpace(username))
        {
            validationErrors["username"] = "Username is required";
        }

        if (string.IsNullOrWhiteSpace(password))
        {
            validationErrors["password"] = "Password is required";
        }

        // if (username?.Length < 3)
        // {
        //     validationErrors["username"] = "Username must be at least 3 characters";
        // }

        // if (password?.Length < 6)
        // {
        //     validationErrors["password"] = "Password must be at least 6 characters";
        // }

        return validationErrors.Count == 0;
    }

    private async Task HandleLogin()
    {
        // reset errors
        validationErrors.Clear();
        errorMessage = string.Empty;

        // client-side validation
        if (string.IsNullOrWhiteSpace(username))
            validationErrors["username"] = "Username is required";
        if (string.IsNullOrWhiteSpace(password))
            validationErrors["password"] = "Password is required";

        if (validationErrors.Count > 0)
            return;

        isLoading = true;

        try
        {
            // call client-side auth service which posts to /api/auth/login
            var resp = await AuthService.LoginAsync(username, password);

            // map response to server LoginResponse DTO (Token, Username, Role, FullName)
            if (resp == null)
            {
                errorMessage = "Invalid username or password";
                return;
            }

            // store token + user
            await AuthService.StoreAuthDataAsync(resp);

            // redirect based on role (lowercase-normalize)
            var role = resp.Role?.ToLowerInvariant() ?? string.Empty;

            if (role == "superadmin")
                Navigation.NavigateTo("/admin/dashboard", true);
            else if (role == "admin")
                Navigation.NavigateTo("/admin/dashboard", true);
            else
                Navigation.NavigateTo("/home", true);
        }
        catch (System.Net.Http.HttpRequestException)
        {
            errorMessage = "Unable to reach server. Please check your network.";
        }
        catch (Exception ex)
        {
            // generic fallback - show friendly message
            errorMessage = $"Login failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }


    private void ActivateLockout(int seconds)
    {
        lockoutSeconds = seconds;
        lockoutTimer = new System.Timers.Timer(1000);
        lockoutTimer.Elapsed += (sender, e) =>
        {
            lockoutSeconds--;
            StateHasChanged();

            if (lockoutSeconds <= 0)
            {
                lockoutTimer?.Stop();
                lockoutTimer?.Dispose();
            }
        };
        lockoutTimer.Start();
    }

    public void Dispose()
    {
        lockoutTimer?.Dispose();
    }
}
